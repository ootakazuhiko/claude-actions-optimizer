name: Claude Review Processor

on:
  issue_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

jobs:
  process-review:
    runs-on: ubuntu-latest
    if: |
      (github.event.issue.pull_request && contains(github.event.comment.body, '@claude-review')) ||
      contains(github.event.review.body, '@claude-review') ||
      contains(github.event.comment.body, '@claude-review')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract Claude Instance Info
        id: extract
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            COMMENT_BODY="${{ github.event.review.body }}"
          else
            COMMENT_BODY="${{ github.event.comment.body }}"
          fi
          
          # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã‚’æŠ½å‡º [Role-Name-Timestamp]
          INSTANCE_ID=$(echo "$COMMENT_BODY" | grep -oE '\[([A-Za-z]+-[A-Za-z]+-[0-9]+)\]' | head -1 | tr -d '[]')
          
          if [ -z "$INSTANCE_ID" ]; then
            echo "âŒ No Claude instance ID found in review"
            exit 0
          fi
          
          # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±ã‚’åˆ†è§£
          ROLE=$(echo "$INSTANCE_ID" | cut -d'-' -f1)
          NAME=$(echo "$INSTANCE_ID" | cut -d'-' -f2)
          TIMESTAMP=$(echo "$INSTANCE_ID" | cut -d'-' -f3)
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$COMMENT_BODY" > review_body.txt
      
      - name: Parse Review Content
        id: parse
        if: steps.extract.outputs.instance_id != ''
        run: |
          # Pythonã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’è§£æ
          cat > parse_review.py << 'EOF'
          import re
          import json
          import sys
          
          with open('review_body.txt', 'r') as f:
              content = f.read()
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±ã‚’æŠ½å‡º
          review_data = {
              'type': 'general',
              'severity': 'medium',
              'content': {
                  'summary': '',
                  'problems': [],
                  'suggestions': [],
                  'code_examples': []
              },
              'action_items': []
          }
          
          # ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
          if re.search(r'(?i)(code review|ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼)', content):
              review_data['type'] = 'code'
          elif re.search(r'(?i)(design review|è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼)', content):
              review_data['type'] = 'design'
          elif re.search(r'(?i)(security review|ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼)', content):
              review_data['type'] = 'security'
          elif re.search(r'(?i)(performance review|ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼)', content):
              review_data['type'] = 'performance'
          
          # é‡è¦åº¦ã‚’åˆ¤å®š
          if re.search(r'(?i)(severity:\s*high|é‡è¦åº¦:\s*é«˜|ğŸ”´)', content):
              review_data['severity'] = 'high'
          elif re.search(r'(?i)(severity:\s*low|é‡è¦åº¦:\s*ä½|ğŸŸ¢)', content):
              review_data['severity'] = 'low'
          
          # ã‚µãƒãƒªãƒ¼ã‚’æŠ½å‡º
          summary_match = re.search(r'(?i)(?:summary|è¦ç´„|æ¦‚è¦)[:ï¼š]\s*(.+?)(?:\n|$)', content)
          if summary_match:
              review_data['content']['summary'] = summary_match.group(1).strip()
          
          # å•é¡Œç‚¹ã‚’æŠ½å‡º
          problems_section = re.search(r'(?i)(?:problems?|å•é¡Œç‚¹|issues?)[:ï¼š\n]+(.+?)(?=\n#{1,3}|\n\n|$)', content, re.DOTALL)
          if problems_section:
              problems = re.findall(r'[-â€¢*]\s*(.+)', problems_section.group(1))
              review_data['content']['problems'] = [p.strip() for p in problems]
          
          # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŠ½å‡º
          action_items = re.findall(r'\[\s*\]\s*(.+)', content)
          review_data['action_items'] = [item.strip() for item in action_items]
          
          # çµæœã‚’å‡ºåŠ›
          with open('review_data.json', 'w') as f:
              json.dump(review_data, f, indent=2, ensure_ascii=False)
          
          print(f"severity={review_data['severity']}")
          print(f"type={review_data['type']}")
          print(f"action_items_count={len(review_data['action_items'])}")
          EOF
          
          python3 parse_review.py >> $GITHUB_OUTPUT
      
      - name: Store Review Feedback
        if: steps.extract.outputs.instance_id != ''
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ§‹é€ åŒ–ã—ã¦ä¿å­˜
          mkdir -p .claude/reviews/${{ steps.extract.outputs.instance_id }}
          
          # PRç•ªå·ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            REVIEWER="${{ github.event.review.user.login }}"
            REVIEW_URL="${{ github.event.review.html_url }}"
          else
            REVIEWER="${{ github.event.comment.user.login }}"
            REVIEW_URL="${{ github.event.comment.html_url }}"
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼JSONã‚’ä½œæˆ
          cat > .claude/reviews/${{ steps.extract.outputs.instance_id }}/review-${{ github.run_id }}.json << EOF
          {
            "review_id": "${{ github.run_id }}",
            "instance_id": "${{ steps.extract.outputs.instance_id }}",
            "pr_number": "$PR_NUMBER",
            "reviewer": "$REVIEWER",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "review_type": "$(cat review_data.json | jq -r .type)",
            "severity": "$(cat review_data.json | jq -r .severity)",
            "content": $(cat review_data.json | jq .content),
            "action_items": $(cat review_data.json | jq .action_items),
            "github_url": "$REVIEW_URL",
            "status": "pending"
          }
          EOF
          
          echo "âœ… Review stored successfully"
          
      - name: Create Review Issue for High Severity
        if: steps.parse.outputs.severity == 'high' && steps.extract.outputs.instance_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const instanceId = '${{ steps.extract.outputs.instance_id }}';
            const role = '${{ steps.extract.outputs.role }}';
            const name = '${{ steps.extract.outputs.name }}';
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const reviewData = JSON.parse(fs.readFileSync('review_data.json', 'utf8'));
            
            // PRç•ªå·ã‚’å–å¾—
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            
            // é«˜é‡è¦åº¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã€å°‚ç”¨Issueã‚’ä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Review] Action required for ${name} (${role}) - PR #${prNumber}`,
              body: `## ğŸ“‹ é«˜é‡è¦åº¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
              
              **å¯¾è±¡Claude**: ${name} (${role})
              **Instance ID**: \`${instanceId}\`
              **PR**: #${prNumber}
              **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: @${context.payload.comment?.user.login || context.payload.review?.user.login}
              **é‡è¦åº¦**: ğŸ”´ HIGH
              
              ### ğŸ“Œ è¦ç´„
              ${reviewData.content.summary || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¦ç´„ã‚’ç¢ºèªã—ã¦ãã ã•ã„'}
              
              ### âš ï¸ å•é¡Œç‚¹
              ${reviewData.content.problems.map(p => `- ${p}`).join('\n')}
              
              ### âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 
              ${reviewData.action_items.map(item => `- [ ] ${item}`).join('\n')}
              
              ---
              [å…ƒã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹](${context.payload.comment?.html_url || context.payload.review?.html_url})
              
              @${name} ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯é«˜é‡è¦åº¦ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚æ—©æ€¥ãªå¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
              labels: [`claude:${role}`, `claude:${name}`, 'review-feedback', 'high-priority', 'action-required']
            });
            
            console.log(`Created issue #${issue.data.number} for high severity review`);
      
      - name: Add PR Comment
        if: steps.extract.outputs.instance_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const instanceId = '${{ steps.extract.outputs.instance_id }}';
            const name = '${{ steps.extract.outputs.name }}';
            const role = '${{ steps.extract.outputs.role }}';
            const severity = '${{ steps.parse.outputs.severity }}';
            const actionItemsCount = '${{ steps.parse.outputs.action_items_count }}';
            
            // PRç•ªå·ã‚’å–å¾—
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            // é‡è¦åº¦ã«å¿œã˜ãŸçµµæ–‡å­—
            const severityEmoji = {
              'high': 'ğŸ”´',
              'medium': 'ğŸŸ¡',
              'low': 'ğŸŸ¢'
            }[severity] || 'âšª';
            
            const comment = `ğŸ¤– **Claude Review Feedback Processed**
            
            - **Target**: ${name} (${role})
            - **Instance ID**: \`${instanceId}\`
            - **Severity**: ${severityEmoji} ${severity.toUpperCase()}
            - **Action Items**: ${actionItemsCount}
            
            Review has been stored and is available for the Claude instance to process.
            
            To check this review:
            \`\`\`bash
            ./scripts/claude-review-check.sh pr ${prNumber}
            \`\`\``;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
      
      - name: Commit Review Data
        if: steps.extract.outputs.instance_id != ''
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .claude/reviews/
          git commit -m "chore: store review feedback for ${{ steps.extract.outputs.instance_id }}
          
          Review from @${{ github.event.comment.user.login || github.event.review.user.login }}
          PR: #${{ github.event.issue.number || github.event.pull_request.number }}
          Severity: ${{ steps.parse.outputs.severity }}
          Type: ${{ steps.parse.outputs.type }}"
          
          git push origin HEAD