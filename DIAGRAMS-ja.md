# システム構成図とフロー図

## 📊 システム全体構成図

### 1. システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                     Claude Code 最適化システム                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌──────────────┐     ┌────────────────┐  │
│  │   開発者    │     │ Claude Code  │     │    GitHub      │  │
│  │ (Human)     │────▶│ (AI)         │────▶│   Actions      │  │
│  └─────────────┘     └──────────────┘     └────────────────┘  │
│         │                    │                       │          │
│         │                    ▼                       ▼          │
│         │            ┌──────────────┐       ┌────────────────┐ │
│         └───────────▶│  調整システム │──────▶│ コスト最適化   │ │
│                      │(Coordinator) │       │   エンジン     │ │
│                      └──────────────┘       └────────────────┘ │
│                             │                        │          │
│                             ▼                        ▼          │
│                      ┌──────────────┐       ┌────────────────┐ │
│                      │ ロック管理   │       │  ワークフロー  │ │
│                      │   機構       │       │    制御        │ │
│                      └──────────────┘       └────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2. コンポーネント関係図

```
                        claude-actions-optimizer/
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
    install.sh              scripts/                  templates/
        │                         │                         │
        ▼                         ▼                         ▼
  ┌──────────┐          ┌─────────────────┐      ┌──────────────┐
  │プロジェクト│          │claude-coordinator│      │  CLAUDE.md   │
  │タイプ検出 │          │    .sh          │      │              │
  └──────────┘          └─────────────────┘      └──────────────┘
        │                         │                         │
        ▼                         ▼                         ▼
  ┌──────────┐          ┌─────────────────┐      ┌──────────────┐
  │ 最適化   │          │  ファイルロック  │      │ ドラフトPR   │
  │ 適用     │          │    管理         │      │ ワークフロー │
  └──────────┘          └─────────────────┘      └──────────────┘
```

---

## 🔄 動作フロー図

### 1. インストールフロー

```
開始
 │
 ▼
プロジェクトタイプを検出
 │
 ├─── Node.js ───┐
 ├─── Python ────┤
 ├─── Java ──────┤
 └─── その他 ────┤
                 │
                 ▼
        言語別テンプレート選択
                 │
                 ▼
        既存ワークフロー分析
                 │
                 ├─── 重複あり ──→ 統合提案
                 │
                 └─── 重複なし
                       │
                       ▼
              最適化ルール適用
                       │
                       ▼
              CLAUDE.md 生成
                       │
                       ▼
              設定ファイル作成
                       │
                       ▼
                    完了
```

### 2. 開発フロー（単一インスタンス）

```
開発開始
   │
   ▼
ブランチ作成
   │
   ▼
Claude Codeで編集 ──────────────┐
   │                           │
   ▼                           ▼
コミット                  CLAUDE.md確認
   │                           │
   ▼                           ▼
ドラフトPR作成 ←─────── 自動的にドラフト
   │
   ▼
┌─────────────┐
│ 開発ループ   │
│             │
│  編集       │
│   ↓         │
│  コミット    │ ← 軽量チェック（1分）
│   ↓         │
│  プッシュ    │
│   ↓         │
│  確認       │
└─────────────┘
   │
   ▼
レビュー準備完了？
   │
   ├─── No ──→ 開発継続
   │
   └─── Yes
         │
         ▼
    gh pr ready
         │
         ▼
   フルテスト（20分）
         │
         ▼
      マージ
```

### 3. マルチインスタンスフロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Claude #1      │     │  Claude #2      │     │  Claude #3      │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
    調整システム            調整システム            調整システム
    チェック                チェック                チェック
         │                       │                       │
         ▼                       ▼                       ▼
   ┌─────────────────────────────────────────────────────┐
   │              中央ロック管理システム                   │
   │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  │
   │  │auth.tsx│  │header  │  │footer  │  │utils   │  │
   │  │ [空き] │  │ [空き] │  │ [空き] │  │ [空き] │  │
   │  └────────┘  └────────┘  └────────┘  └────────┘  │
   └─────────────────────────────────────────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
    auth.tsx               header.tsx              footer.tsx
    ロック取得             ロック取得              ロック取得
         │                       │                       │
         ▼                       ▼                       ▼
      編集開始               編集開始               編集開始
         │                       │                       │
    ［並行作業］           ［並行作業］           ［並行作業］
         │                       │                       │
         ▼                       ▼                       ▼
      編集完了               編集完了               編集完了
         │                       │                       │
         ▼                       ▼                       ▼
    ロック解放             ロック解放              ロック解放
         │                       │                       │
         ▼                       ▼                       ▼
   ドラフトPR #1         ドラフトPR #2          ドラフトPR #3
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                                 ▼
                          競合なしでマージ可能
```

---

## 💰 コスト削減メカニズム

### 1. 従来のフローとコスト

```
従来のフロー（最適化なし）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

コミット ──→ PR作成 ──→ 全ワークフロー実行
                           │
                           ├─→ ci.yml (5分)
                           ├─→ test.yml (8分)
                           ├─→ lint.yml (3分)
                           ├─→ security.yml (2分)
                           └─→ e2e.yml (2分)
                                    │
                                    ▼
                              合計: 20分/コミット
                                    │
                                    ▼
                           100コミット/日 = 2,000分
                                    │
                                    ▼
                              月間: $480
```

### 2. 最適化後のフローとコスト

```
最適化後のフロー
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

コミット ──→ ドラフトPR ──→ 軽量チェックのみ
                              │
                              └─→ draft-check.yml (1分)
                                       │
                                       ▼
                                 開発中: 1分/コミット
                                       │
         ┌─────────────────────────────┘
         │
         ▼
    レビュー準備 ──→ フルテスト
                        │
                        ├─→ 統合ci.yml (15分)
                        └─→ 重複削除により5分短縮
                              │
                              ▼
                        レビュー時: 15分/PR
                              │
                              ▼
                    95コミット × 1分 = 95分
                     5PR × 15分 = 75分
                        合計: 170分/日
                              │
                              ▼
                        月間: $24 (95%削減！)
```

---

## 🔐 ロック機構の詳細

### アトミックロック実装

```
ファイルロック取得プロセス
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

要求: src/auth/login.tsx をロック
         │
         ▼
┌──────────────────────┐
│ ロックファイル生成    │
│ (set -C で排他制御)  │
└──────────────────────┘
         │
    成功？───── No ──→ 既にロック済み
         │                    │
        Yes                   ▼
         │              エラーメッセージ
         ▼              "既にロックされています"
   ロック情報記録
         │
         ▼
┌──────────────────────┐
│ .claude/file_locks/  │
│ src_auth_login.tsx   │
│ .lock                │
│ 内容: instance-id    │
└──────────────────────┘
         │
         ▼
   YAMLファイル更新
         │
         ▼
┌──────────────────────┐
│ locks.yml            │
│ - path: "src/..."    │
│   locked_by: "..."   │
│   expires_at: "..."  │
└──────────────────────┘
         │
         ▼
    ロック取得成功
```

### ロック競合解決フロー

```
競合発生時の処理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Instance A                    Instance B
    │                            │
    ├──── 同時にロック要求 ────────┤
    │                            │
    ▼                            ▼
ロック試行                    ロック試行
    │                            │
    ▼                            ▼
成功（最初）                  失敗（既存）
    │                            │
    ▼                            ▼
編集開始                     代替案選択
    │                            │
    │                            ├─→ 1. 別ファイル編集
    │                            │
    │                            ├─→ 2. 待機（最大60分）
    │                            │
    │                            └─→ 3. 別タスク選択
    │
    ▼
編集完了
    │
    ▼
ロック解放 ─────────────────→ Instance B 再試行可能
```

---

## 📈 パフォーマンスメトリクス

### CI実行時間の分布

```
実行時間分布（最適化前）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

25分 ┤                                    ████
20分 ┤                          ████████████████
15分 ┤                ████████████████████
10分 ┤      ████████████████
 5分 ┤████████
 0分 └────────────────────────────────────────
     構文  Lint  単体  結合  E2E  セキュリティ


実行時間分布（最適化後）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

25分 ┤
20分 ┤                                      ████ (レビュー時のみ)
15分 ┤
10分 ┤
 5分 ┤
 0分 ┤████                                      (開発中)
     └────────────────────────────────────────
     軽量チェック                         フルテスト
```

### 月間コスト推移

```
月間GitHub Actionsコスト
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

$500 ┤████
$400 ┤████████
$300 ┤████████████
$200 ┤████████████████
$100 ┤████████████████████                    ████
$  0 └────────────────────────────────────────────
      1月   2月   3月   4月   5月   6月   7月
                           ↑
                     最適化システム導入

削減額: $456/月 (95%削減)
年間削減額: $5,472
```

---

## 🛠️ トラブルシューティングフロー

```
問題発生
   │
   ▼
問題の種類は？
   │
   ├─── ロック関連 ─────┐
   │                   │
   ├─── CI未実行 ──────┤
   │                   │
   └─── コスト超過 ─────┤
                       │
                       ▼
                  詳細診断
                       │
   ┌───────────────────┼───────────────────┐
   │                   │                   │
   ▼                   ▼                   ▼
ロック診断          CI診断            コスト診断
   │                   │                   │
   ▼                   ▼                   ▼
期限確認          設定確認           使用量確認
   │                   │                   │
   ▼                   ▼                   ▼
手動解放？        条件確認           制限設定
   │                   │                   │
   └───────────────────┴───────────────────┘
                       │
                       ▼
                  解決策実行
                       │
                       ▼
                    動作確認
```

---

これらの図解により、システムの構成と動作フローが視覚的に理解できるようになっています。